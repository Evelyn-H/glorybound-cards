
\pgfkeys{/card/.cd,% set the initial path
    name/.initial={},
    % type/.initial={},
    cost/.initial={},
    text/.initial={},
    path/.initial={},
    color-left/.initial=FF00FF,
    color-right/.initial=0000FF,
    % types
    permanent/.code={\pgfkeyssetvalue{permanent}{#1}},
    sequence/.code={\pgfkeyssetvalue{sequence}{#1}},
    oneshot/.code={\pgfkeyssetvalue{oneshot}{#1}},
    innate/.code={\pgfkeyssetvalue{innate}{#1}},
    linked/.code={\pgfkeyssetvalue{linked}{#1}},
    linked type/.initial={},
    heirloom/.code={\pgfkeyssetvalue{heirloom}{#1}},
    support/.code={\pgfkeyssetvalue{support}{#1}},
    % purchase stuff
    purchase/.code={\pgfkeyssetvalue{purchase}{#1}},
    % upgrade stuff
    upgrade/.code={\pgfkeyssetvalue{upgrade}{#1}},
    upgrade cost/.code={\pgfkeyssetvalue{upgrade cost}{#1}},
    % read-only key to get the printed type line
    type/.initial={%
        \printsepifnotempty{%
            \pgfkeysifdefined{linked}{Linked}{%
                \pgfkeysifdefined{heirloom}{Heirloom}{%
                    \pgfkeysifdefined{purchase}{Advanced}{Starter}%
                }%
            }%
        }
        {\ --\ }
        {%
            \printsepifnotemptyor{\pgfkeysifdefined{innate}{Innate}{}}{ }{%
                \printsepifnotemptyor{\pgfkeysifdefined{support}{Support}{}}{ }{%
                    \printsepifnotemptyor{\pgfkeysifdefined{permanent}{Permanent}{}}{ }{%
                        \pgfkeysifdefined{sequence}{Sequence}{}%
                    }%
                }%
            }%
            % % supertypes
            % \pgfkeysifdefined{innate}{Innate }{}%
            % \pgfkeysifdefined{support}{Support }{}%
            % % \pgfkeysifdefined{linked}{Linked }{}%
            % % base types
            % \pgfkeysifdefined{permanent}{Permanent }{}%
            % \pgfkeysifdefined{sequence}{Sequence }{}%
        }
    },
    % art path
    art path/.initial={%
        art/\pgfkeysvalueof{/card/path}/\fixpath{\pgfkeysvalueof{/card/name}}.png%
    },
    % night mode toggle, not meant to be used directly in card definitions
    night/.code={\pgfkeyssetvalue{night}{#1}},%
    big art/.code={\pgfkeyssetvalue{big art}{#1}},%
    designer/.code={\pgfkeyssetvalue{designer}{#1}},%
}

\newcommand{\setpath}[3]{
    % \finishpathfile
    \pgfkeys{/card/.cd,
        path=#1,
        color-left=#2,
        color-right=#3,
    }
    % \beginpathfile{#1}
}

\newsavebox{\rulestextbox}
\newlength{\savedfontsize}
\newlength{\savedheight}
\newlength{\extraheight}
\newcommand{\buildbox}[1][0mm]{}

\newlength{\textboxbottomoffset}
\setlength{\textboxbottomoffset}{0mm}

\newlength{\templen}

\makeatletter
\let\upgradereplacement\@empty
\makeatother

% to trim art images to the size of the content:
% mogrify -trim +repage *.png

% to fill art with the path's gradient:
% convert -size $(identify -format %Wx%H Retribution.png) -define gradient:direction=Northeast gradient:"#00DB1D"-"#BF00FF" Retribution.png -compose copy_opacity -composite result.png

\begin{luacode*}
    function generate_art(folder, name, col1, col2)
        local file = io.popen("cd '"..folder.."' && convert -size $(identify -format %Wx%H '"..name..".png') -define gradient:direction=Northeast gradient:'#"..col1.."'-'#"..col2.."' '"..name..".png' -compose copy_opacity -composite '"..name.."-"..col1.."-"..col2..".png'")
        local output = file:read('*all')
        file:close()
    end
    function get_art(path, col1, col2)
        name = path:match("^.*/([^/]*).png$")
        folder = path:match("^(.*)/[^/]*$")
        filename = folder.."/"..name.."-"..col1.."-"..col2..".png"
        texio.write("artname: "..filename)
        -- check if it already exists
        local f = io.open(""..filename.."", "r")
        if f~=nil then 
            io.close(f) 
            return filename
        else 
            generate_art(folder, name, col1, col2)
            return filename  
        end
    end
\end{luacode*}
\newcommand{\getart}[3]{\directlua{tex.print(get_art(\luastring{#1}, \luastring{#2}, \luastring{#3}))}}

\makeatletter
\NewDocumentCommand{\card}{ +O{} }{

    % start a new page if we have to
    \clearpage

    % to make sure no arguments "leak" between different \card calls
    \begingroup
    % handle key-value arguments
    \pgfkeys{/card/.cd, #1}
    
    % increase our page counter and track card
    \countpage
    \registercard{\pgfkeysvalueof{/card/path}}{\pgfkeysvalueof{/card/name}}

    % handle night-mode cards
    % \pgfkeyssetvalue{night}{}%
    \pgfkeysifdefined{linked}{%
        \pgfkeyssetvalue{night}{}%
    }{}
    
    % set night mode colors
    \pgfkeysifdefined{night}{%
        % \colorlet{dark}{red}
        % \colorlet{light}{green}
        \colorlet{dark}{white}
        \colorlet{light}{black!90}
        \colorlet{sequencecolor}{dark!70!light!30}
        \colorlet{ugradegray}{dark!25!light!75}
    }{%
        \colorlet{dark}{black}
        \colorlet{light}{white}
        \colorlet{sequencecolor}{dark!70}
        \colorlet{ugradegray}{dark!25!light!75}
    }

    % render frame
    % the tikz stuff makes sure it's rendered in the background and not
    % as part of the document flow
    
    % background gradient:
    \definecolor{left}  {HTML}{\pgfkeysvalueof{/card/color-left}}
    \definecolor{right} {HTML}{\pgfkeysvalueof{/card/color-right}}
    \tikz[overlay, remember picture] 
    \node[
        anchor=north,
        yshift=-1.5mm,
        rectangle, 
        minimum width=\paperwidth-3mm, 
        minimum height=\paperheight-3mm,
        left color=left, 
        right color=right,
        shading = axis,
        shading angle=135, 
    ] at (current page.north) {};
    
    % frame (with transparency):
    \tikz[overlay, remember picture] 
    \node[
        anchor=north, 
        inner ysep=0pt,
        inner xsep=0pt,
        outer ysep=0pt,
        outer xsep=0pt,
    ] at (current page.north) {
        % \includegraphics[width=63mm]{icons/frame2.png}
        \includegraphics[width=63mm]{%
            % \pgfkeysifdefined{linked}{icons/frame2-gray.png}{icons/frame2.png}
            % icons/frame2.png
            % icons/frame2\pgfkeysifdefined{permanent}{-permanent}{}\pgfkeysifdefined{night}{-night}{}.png
            icons/frame2\pgfkeysifdefined{heirloom}{-heirloom}{}\pgfkeysifdefined{permanent}{-permanent}{}\pgfkeysifdefined{night}{-night}{}.png
            % icons/frame2-dark.png
        }
    };

    % cost
    \rendermana{\pgfkeysvalueof{/card/cost}}
    % \rendermanasymbol{1}{W}
    % \rendermanasymbol{2}{S}
    % \rendermanasymbol{3}{A}
    
    % make sure we have the right font ny default
    \bodyfont
    
    % name
    \bettertextbox
        [y=4.5mm, width=36mm, height=6mm, margin=0mm, fontsize=14pt, font=\titlefont\bfseries]
        [halign=center, valign=centerline]
    {%
        \pgfkeysvalueof{/card/name}%
    }
     
    % type
    \bettertextbox
        [y=11mm, width=36mm, height=4mm, margin=0mm, fontsize=8pt, font=\titlefont\sbseries\itshape]
        [halign=center, valign=centerline]
    {%
        \pgfkeysvalueof{/card/type}%
        % Basic -- \pgfkeysvalueof{/card/type}
    }

    % purchase cost?
    \newcommand{\purchaseunderlay}{%
    \begin{tcbclipinterior}
        \node[
            fit={(frame.north west) (frame.south east)},
            anchor=center,
            rectangle,
            rounded corners=1mm,
            inner sep=0pt,
            fill=dark!25!light!75,
        ] at (frame.center) {};
    \end{tcbclipinterior}
    }
    \pgfkeysifdefined{purchase}{%
        \bettertextbox
            [%
                y=5mm, x=26.5mm,
                width=6mm, height=10.5mm, margin=1mm, 
                anchor=north east,
                fontsize=14pt, 
                font=\bfseries,
            ]
            [%
                halign=center, valign=center,
                underlay={\purchaseunderlay},
                underlay={
                    \begin{tcbclipframe}
                        \node[
                            anchor=north,
                            inner sep=0pt,
                            yshift=-1mm,
                            % opacity=0.5,
                        ] at (frame.north) {\includegraphics[height=3.5mm]{icons/padlock\pgfkeysifdefined{night}{-night}{}.png}};
                    \end{tcbclipframe}
                },
                top=5.5mm,
            ]
        {%
            \pgfkeysvalueof{purchase}%
        }
    }{%
        % not defined
    }

    % upgrade?
    \setlength{\extraheight}{0mm}
    \newcommand{\upgradeunderlay}{%
        \begin{tcbclipinterior}
            \node[
                fit={(frame.north west) (frame.south east)},
                anchor=center,
                rectangle,
                rounded corners=1mm,
                inner sep=0pt,
                fill=\pgfkeysifdefined{heirloom}{dark!25!heirloomlight!75}{dark!25!light!75},
            ] at (frame.center) {};
        \end{tcbclipinterior}
    }
    \pgfkeysifdefined{upgrade cost}{%
        \bettertextbox
            [%
                y=81.5mm, x=27mm,
                width=42mm, height=6mm, margin=1mm, 
                anchor=south east,
                fontsize=8pt,
            ]
            [%
                halign=flush center, valign=center, left=1mm, right=1mm,
                fit height plus=4mm,
                underlay={%
                    \upgradeunderlay%
                    \setlength{\extraheight}{\tcbtextheight}
                    \global\extraheight=\extraheight
                },
            ]
        {%
            % this is purely to "evaluate" /card/text,
            % so we can force all the \upgrade{}{} commands to be executed
            \global\let\upgradereplacement\@empty%
            \sbox\rulestextbox{\parbox{54mm}{\pgfkeysvalueof{/card/text}}}%
            \upgradereplacement%
            \pgfkeysvalueof{upgrade}%
        }
        % add the margin back in
        \setlength{\extraheight}{\extraheight + 2mm}
        % \the\extraheight

        \setlength{\templen}{%
            \directlua{%
                if string.len(\luastring{\pgfkeysvalueof{upgrade cost}}) > 1 then
                    tex.sprint("12pt")
                else
                    tex.sprint("14pt")
                end
            }
        }
        \bettertextbox
            [%
                y=81.5mm, x=-27mm,
                width=11mm, height=\extraheight, margin=1mm, 
                anchor=south west,
                fontsize=\templen,
                font=\bfseries,
            ]
            [%
                halign=center, valign=centerline,
                underlay={\upgradeunderlay},
                underlay={
                    \begin{tcbclipframe}
                        \node[
                            anchor=west,
                            inner sep=0pt,
                            xshift=1mm,
                            % opacity=0.5,
                        ] at (frame.west) {\includegraphics[height=4mm]{icons/upgrade\pgfkeysifdefined{night}{-night}{}.png}};
                    \end{tcbclipframe}
                },
                left=4.5mm,
            ]
        {%
            \pgfkeysvalueof{upgrade cost}%
        }
        \addtolength{\textboxbottomoffset}{\extraheight}
    }{%
        % not defined
    }

    % oneshot?
    % \pgfkeysifdefined{oneshot}{%
    %     % defined 
    %     \tikz[overlay, remember picture] 
    %     \node[
    %         anchor=south, 
    %         inner ysep=0pt,
    %         inner xsep=0pt,
    %         outer ysep=0pt,
    %         outer xsep=0pt,
    %         % yshift=7.5mm,
    %         yshift=7mm+\textboxbottomoffset,
    %     ] at (current page.south) {
    %         % \includegraphics[width=36mm]{icons/oneshot-banner.png}
    %         \includegraphics[width=30mm]{icons/oneshot-banner\pgfkeysifdefined{night}{-night}{}.png}
    %     };
    %     \addtolength{\textboxbottomoffset}{5mm}
    % }{%
    %     % not defined
    % }

    % text
    \renewcommand{\buildbox}{%
        \sbox{\rulestextbox}{
            \setlength{\savedheight}{34mm - \textboxbottomoffset + \extraheight}
            \bettertextbox
                [%
                    y={81.5mm+\textboxbottomoffset}, 
                    width=54mm, 
                    % height=\pgfkeysifdefined{oneshot}{24mm}{32mm}, 
                    height=\savedheight, 
                    anchor=south, 
                    margin=2mm,
                ]
                [%
                    valign=center, %bottom=0.25mm, % the bottom=... just adds some extra spacing there
                    % top=-2mm,
                    top=\pgfkeysifdefined{innate}{-1mm}{0mm},
                    bottom=\pgfkeysifdefined{oneshot}{-1mm}{0.25mm},
                    underlay=\pgfkeysifdefined{permanent}{%
                        % \begin{tcbclipinterior}
                        %     \node[
                        %         anchor=center, 
                        %         opacity=0.15,
                        %         % yshift=1mm
                        %     ] at (frame.center) {
                        %         \includegraphics[height=14mm]{permanent-watermark.png}
                        %     };
                        % \end{tcbclipinterior}
                    }{}
                ] 
            {%
                \pgfkeysifdefined{innate}{%
                    % {\centering\includegraphics[width=36mm]{icons/innate-banner.png}\par}
                    % \textit{\textsb{Innate} (Play before the match starts.)}\par%
                    \innatebanner
                    % \textbf{Innate:} \textit{Play before the match starts.}\par%
                }{}%
                \pgfkeysifdefined{linked}{%
                    \textit{\printsepifnotemptyor{%
                        \pgfkeysvalueof{/card/linked type}%
                    }{\ --\ }{}%
                    \textsb{Linked} (This card begins the match banished and is recalled by \pgfkeysvalueof{linked}.)%
                    }\par%
                }{}%
                \pgfkeysifdefined{support}{%
                \textit{\textsb{Support} (Not used during match.)}%
                    \par%
                }{}%
                \pgfkeysvalueof{/card/text}%
                \global\setlength{\savedfontsize}{\tcbfitdim}
                \global\savedfontsize=\savedfontsize
                \pgfkeysifdefined{oneshot}{%
                    \oneshotbanner
                }{}%

            }%
        }
    }
    \setlength{\extraheight}{0mm}
    \pgfkeysifdefined{big art}{
        \setlength{\extraheight}{-14mm}
    }{}
    \buildbox
    \loop
    \ifdim\savedfontsize<8pt
        \setlength{\extraheight}{\extraheight + 2mm}
        \global\extraheight=\extraheight
        \buildbox
    \repeat
    % \ifdim\savedfontsize<7pt
    %     \setlength{\extraheight}{6mm}
    %     \buildbox
    % \else
    % \fi

    \usebox{\rulestextbox}
    % \the\savedfontsize

    \pgfkeysifdefined{designer}{%
        \bettertextbox[%
            % y={17mm+15mm-0.5\extraheight},
            y={32mm-0.5\extraheight},
            x=26.5mm,
            width={30mm-\extraheight}, height=6mm, margin=1mm, 
            anchor=north,
            rotate=-90,
            fontsize=5pt, 
            font=\titlefont,
        ]
        [%
            halign=center, valign=center,
        ]{%
            \textit{Champion's Design Challenge 2022\linebreak
            Designed by \textsb{\pgfkeysvalueof{designer}}}
        }
    }{}%
    

    % art:
    % (just a placeholder rectangle currently)
    % \typeout{ART: \pgfkeysvalueof{/card/art path}}
    \IfFileExists{\pgfkeysvalueof{/card/art path}}{
        \tikz[overlay, remember picture] 
        \node[
            anchor=north,
            yshift=-17mm,
            rectangle, 
            minimum width=36mm, 
            minimum height=30mm-\extraheight,
            inner sep=0pt,
            % fill=gray,
        ] at (current page.north) {%
            \includegraphics
                [width=36mm, height={30mm-\extraheight}, keepaspectratio]
                {%
                    \pgfkeysifdefined{heirloom}{%
                        \getart{\pgfkeysvalueof{/card/art path}}{000000}{000000}
                    }{%
                        \getart{\pgfkeysvalueof{/card/art path}}{\pgfkeysvalueof{/card/color-left}}{\pgfkeysvalueof{/card/color-right}}%
                    }%
                }%
        };
    }{%
        \tikz[overlay, remember picture] 
        \node[
            anchor=north,
            yshift=-17mm,
            rectangle, 
            minimum width=36mm, 
            minimum height=30mm-\extraheight,
            left color=left, 
            right color=right,
            shading = axis,
            shading angle=135, 
            opacity = 0.3,
        ] at (current page.north) {%
        };
    }
    
    % path
    % \pgfkeysifdefined{heirloom}{}{%
    \bettertextbox
        [y=81.5mm, x=-27mm, width=24mm, height=4mm, anchor=north west, font=\titlefont\color{white}\sbseries, fontsize=7pt, margin=0.5mm]
        [valign=centerline, left=-0.5mm]
    {%
        \pgfkeysifdefined{heirloom}{%
            \pgfkeysifdefined{designer}{%
                % \textit{Champion's Design Challenge}\linebreak
                % Designed by \pgfkeysvalueof{designer}%
            }{}%
            % \pgfkeysifdefined{designer}{2021 Champion Designer: \pgfkeysvalueof{designer}}{}%
        }{%
            \pgfkeysvalueof{/card/path}%
        }%
    }
    % }%

    
    % date - glorybound
    \bettertextbox
        [y=81.5mm, x=27mm, width=24mm, height=4mm, anchor=north east, font=\titlefont\color{white}\sbseries, fontsize=7pt, margin=0.5mm]
        [valign=centerline, right=-0.5mm, halign=flush right]
    {%
        % \today\ \ --\ \ Glorybound
        \today\ \ --\ \ GLORYBOUND
        % \today\ \ --\ \ \fauxsc{Glorybound}
    }

    \endgroup
}
\makeatother
