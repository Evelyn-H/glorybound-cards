\pgfkeys{/card/.cd,% set the initial path
    name/.initial={},
    % type/.initial={},
    cost/.initial={},
    text/.initial={},
    path/.initial={},
    color-left/.initial=FF00FF,
    color-right/.initial=0000FF,
    permanent/.code={\pgfkeyssetvalue{permanent}{#1}},
    sequence/.code={\pgfkeyssetvalue{sequence}{#1}},
    oneshot/.code={\pgfkeyssetvalue{oneshot}{#1}},
    innate/.code={\pgfkeyssetvalue{innate}{#1}},
    extra/.code={\pgfkeyssetvalue{extra}{#1}},
    % read-only key to get the printed type line
    type/.initial={%
        % supertypes
        \pgfkeysifdefined{innate}{Innate }{}%
        \pgfkeysifdefined{extra}{Forgotten }{}%
        % base types
        \pgfkeysifdefined{permanent}{Permanent }{}%
        \pgfkeysifdefined{sequence}{Sequence }{}%
    }
}

\newcommand{\setpath}[3]{
    \pgfkeys{/card/.cd,
        path=#1,
        color-left=#2,
        color-right=#3,
    }
}

\newsavebox{\rulestextbox}
\newlength{\savedfontsize}
\newlength{\savedheight}
\newlength{\extraheight}
\newcommand{\buildbox}[1][0mm]{}

\makeatletter
\NewDocumentCommand{\card}{ +O{} }{

    % start a new page if we have to
    \clearpage

    % to make sure no arguments "leak" between different \card calls
    \begingroup
    % handle key-value arguments
    \pgfkeys{/card/.cd, #1}
    
    % render frame
    % the tikz stuff makes sure it's rendered in the background and not
    % as part of the document flow
    
    % background gradient:
    \definecolor{left}  {HTML}{\pgfkeysvalueof{/card/color-left}}
    \definecolor{right} {HTML}{\pgfkeysvalueof{/card/color-right}}
    \tikz[overlay, remember picture] 
    \node[
        anchor=north,
        yshift=-1.5mm,
        rectangle, 
        minimum width=\paperwidth-3mm, 
        minimum height=\paperheight-3mm,
        left color=left, 
        right color=right,
        shading = axis,
        shading angle=135, 
    ] at (current page.north) {};
    
    % frame (with transparency):
    \tikz[overlay, remember picture] 
    \node[
        anchor=north, 
        inner ysep=0pt,
        inner xsep=0pt,
        outer ysep=0pt,
        outer xsep=0pt,
    ] at (current page.north) {
        % \includegraphics[width=63mm]{frame2.png}
        \includegraphics[width=63mm]{%
            \pgfkeysifdefined{extra}{frame2-gray.png}{frame2.png}
        }
        
    };

    % cost
    \rendermana{\pgfkeysvalueof{/card/cost}}
    % \rendermanasymbol{1}{W}
    % \rendermanasymbol{2}{S}
    % \rendermanasymbol{3}{A}
    
    % make sure we have the right font ny default
    \bodyfont
    
    % name
    \bettertextbox
        [y=4.5mm, width=36mm, height=6mm, margin=0mm, fontsize=14pt, font=\titlefont\bfseries]
        [halign=center, valign=centerline]
    {%
        \pgfkeysvalueof{/card/name}
    }
     
    % type
    \bettertextbox
        [y=11mm, width=36mm, height=4mm, margin=0mm, fontsize=8pt, font=\titlefont\sbseries\itshape]
        [halign=center, valign=centerline]
    {%
        \pgfkeysvalueof{/card/type}
        % Basic -- \pgfkeysvalueof{/card/type}
    }

    % oneshot?
    \pgfkeysifdefined{oneshot}{%
        % defined 
        \tikz[overlay, remember picture] 
        \node[
            anchor=south, 
            inner ysep=0pt,
            inner xsep=0pt,
            outer ysep=0pt,
            outer xsep=0pt,
            % yshift=7.5mm,
            yshift=7mm,
        ] at (current page.south) {
            % \includegraphics[width=36mm]{oneshot-banner.png}
            \includegraphics[width=30mm]{oneshot-banner.png}
        };
    }{%
        % not defined
    }

    % text
    \renewcommand{\buildbox}{%
        \sbox{\rulestextbox}{
            \setlength{\savedheight}{\pgfkeysifdefined{oneshot}{29mm}{34mm}}
            \setlength{\savedheight}{\savedheight + \extraheight}
            \bettertextbox
                [%
                    y=\pgfkeysifdefined{oneshot}{76.5mm}{81.5mm}, 
                    width=54mm, 
                    % height=\pgfkeysifdefined{oneshot}{24mm}{32mm}, 
                    height=\savedheight, 
                    anchor=south, 
                    margin=2mm,
                ]
                [valign=center, bottom=0.25mm, % the bottom=... just adds some extra spacing there
                    % top=-2mm,
                    underlay=\pgfkeysifdefined{permanent}{%
                        \begin{tcbclipinterior}
                            \node[
                                anchor=center, 
                                opacity=0.15,
                                % yshift=1mm
                            ] at (frame.center) {
                                \includegraphics[height=14mm]{permanent-watermark.png}
                            };
                        \end{tcbclipinterior}
                    }{}
                ] 
            {%
                \pgfkeysvalueof{/card/text}%
                \global\setlength{\savedfontsize}{\tcbfitdim}
                \global\savedfontsize=\savedfontsize
            }%
        }
    }
    \setlength{\extraheight}{0mm}
    \buildbox
    \loop
    \ifdim\savedfontsize<7pt
        \setlength{\extraheight}{\extraheight + 2mm}
        \global\extraheight=\extraheight
        \buildbox
    \repeat
    % \ifdim\savedfontsize<7pt
    %     \setlength{\extraheight}{6mm}
    %     \buildbox
    % \else
    % \fi

    \usebox{\rulestextbox}
    % \the\savedfontsize

    % art:
    % (just a placeholder rectangle currently)
    \tikz[overlay, remember picture] 
    \node[
        anchor=north,
        yshift=-17mm,
        rectangle, 
        minimum width=36mm, 
        minimum height=30mm-\extraheight,
        left color=left, 
        right color=right,
        shading = axis,
        shading angle=135, 
        opacity = 0.3,
    ] at (current page.north) {};
    
    % path
    \bettertextbox
        [y=81.5mm, x=-27mm, width=24mm, height=4mm, anchor=north west, font=\titlefont\color{white}\sbseries, fontsize=7pt, margin=0.5mm]
        [valign=centerline, left=-0.5mm]
    {%
        \pgfkeysvalueof{/card/path}
    }
    
    % date - glorybound
    \bettertextbox
        [y=81.5mm, x=27mm, width=24mm, height=4mm, anchor=north east, font=\titlefont\color{white}\sbseries, fontsize=7pt, margin=0.5mm]
        [valign=centerline, right=-0.5mm, halign=flush right]
    {%
        \today\ \ --\ \ Glorybound
    }

    \endgroup
}
\makeatother
